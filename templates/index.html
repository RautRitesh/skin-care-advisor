<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Skin Type Analyzer</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .file-input-container {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }
        .file-input-button {
            cursor: pointer;
        }
        .file-input {
            position: absolute;
            font-size: 100px;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6; /* Tailwind blue-500 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 flex flex-col items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-2xl bg-white rounded-2xl shadow-xl p-6 md:p-10">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">AI Skin Type Analyzer</h1>
            <p class="text-gray-600 mt-2">Upload a clear, front-facing photo to get started.</p>
        </header>

        <main>
            <!-- Image Upload Section -->
            <div id="upload-section" class="text-center">
                <div id="image-preview-container" class="mb-6 hidden">
                    <img id="image-preview" src="#" alt="Your uploaded image" class="max-w-xs mx-auto rounded-lg shadow-md max-h-64"/>
                </div>
                <div class="file-input-container">
                    <button id="upload-button" class="file-input-button bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors duration-300 shadow-sm">
                        Select Your Photo
                    </button>
                    <input title="ll" type="file" id="image-upload" class="file-input" accept="image/jpeg, image/png, image/jpg">
                </div>
                <p id="file-name" class="mt-3 text-sm text-gray-500"></p>
            </div>
            
            <!-- Loading Spinner -->
            <div id="loading-spinner" class="hidden flex justify-center items-center my-8">
                 <div class="loader"></div>
            </div>

            <!-- Results Section -->
            <div id="results-section" class="hidden mt-8 text-center">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6">
                    <h2 class="text-lg font-semibold text-gray-700 mb-1">Overall Assessment</h2>
                    <p id="overall-prediction" class="text-3xl font-bold text-blue-800"></p>
                </div>

                <h3 class="text-xl font-semibold text-gray-800 mb-4">Regional Analysis</h3>
                <div id="region-details" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 text-left">
                    <!-- Cards will be inserted here by JavaScript -->
                </div>
                 <button onclick="resetApp()" class="mt-8 bg-gray-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-700 transition-colors duration-300">Analyze Another Photo</button>
            </div>

            <!-- Error Message Display -->
            <div id="error-message" class="hidden mt-6 text-center bg-red-100 border border-red-300 text-red-800 p-4 rounded-lg">
            </div>

        </main>
    </div>

    <footer class="text-center mt-6 text-sm text-gray-500">
        <p>&copy; 2025 SkinSight AI. For educational purposes only.</p>
    </footer>

    <script>
        // Get references to all the important DOM elements
        const imageUpload = document.getElementById('image-upload');
        const imagePreview = document.getElementById('image-preview');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const fileNameDisplay = document.getElementById('file-name');
        const uploadSection = document.getElementById('upload-section');
        const loadingSpinner = document.getElementById('loading-spinner');
        const resultsSection = document.getElementById('results-section');
        const overallPredictionEl = document.getElementById('overall-prediction');
        const regionDetailsEl = document.getElementById('region-details');
        const errorMessageEl = document.getElementById('error-message');
        const uploadButton = document.getElementById('upload-button');

        // Listen for when a user selects a file
        imageUpload.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                // Display a preview of the image
                const reader = new FileReader();
                reader.onload = function(e) {
                    imagePreview.src = e.target.result;
                    imagePreviewContainer.classList.remove('hidden');
                }
                reader.readAsDataURL(file);

                fileNameDisplay.textContent = `Selected: ${file.name}`;
                
                // --- THIS IS THE FIX ---
                // Automatically start the prediction right after the file is selected.
                predict(file); 
            }
        });

        async function predict(file) {
            // 1. SETUP UI FOR LOADING
            showLoading(true);

            // Create a FormData object to send the file
            const formData = new FormData();
            formData.append('file', file);

            // 2. SEND REQUEST TO FLASK BACKEND
            try {
                const response = await fetch('/predict', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();

                // 3. PROCESS THE RESPONSE
                if (response.ok && data.status === 'success') {
                    displayResults(data);
                } else {
                    // Handle errors from the backend (e.g., no face detected)
                    displayError(data.error || 'An unknown error occurred.');
                }
            } catch (error) {
                // Handle network errors
                console.error('Fetch Error:', error);
                displayError('Failed to connect to the server. Please try again.');
            } finally {
                // 4. CLEANUP UI
                showLoading(false);
            }
        }
        
        function showLoading(isLoading) {
            if (isLoading) {
                uploadSection.classList.add('hidden');
                resultsSection.classList.add('hidden');
                errorMessageEl.classList.add('hidden');
                loadingSpinner.classList.remove('hidden');
            } else {
                loadingSpinner.classList.add('hidden');
            }
        }

        function displayResults(data) {
            uploadSection.classList.add('hidden');
            resultsSection.classList.remove('hidden');
            errorMessageEl.classList.add('hidden');

            // Display the overall prediction
            overallPredictionEl.textContent = data.overall_prediction.charAt(0).toUpperCase() + data.overall_prediction.slice(1);

            // Clear previous region details and create new ones
            regionDetailsEl.innerHTML = ''; 
            for (const [region, details] of Object.entries(data.region_predictions)) {
                const card = document.createElement('div');
                card.className = 'bg-gray-50 p-4 rounded-lg border';
                
                // Format region name for display (e.g., 'left_cheek' -> 'Left Cheek')
                const formattedRegion = region.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                
                card.innerHTML = `
                    <h4 class="font-semibold text-gray-700">${formattedRegion}</h4>
                    <p class="text-lg text-gray-900">${details.prediction.charAt(0).toUpperCase() + details.prediction.slice(1)}</p>
                    <p class="text-sm text-gray-500">Confidence: ${(details.confidence * 100).toFixed(1)}%</p>
                `;
                regionDetailsEl.appendChild(card);
            }
        }

        function displayError(message) {
             uploadSection.classList.add('hidden');
             resultsSection.classList.add('hidden');
             errorMessageEl.textContent = `Error: ${message}`;
             errorMessageEl.classList.remove('hidden');
             // Add a reset button to the error message
             errorMessageEl.innerHTML += `<br><button onclick="resetApp()" class="mt-4 bg-gray-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-700 transition-colors duration-300">Try Again</button>`;
        }

        function resetApp() {
            // Reset the UI to its initial state
            imageUpload.value = ''; // Clear the file input
            imagePreview.src = '#';
            imagePreviewContainer.classList.add('hidden');
            fileNameDisplay.textContent = '';
            
            uploadSection.classList.remove('hidden');
            resultsSection.classList.add('hidden');
            errorMessageEl.classList.add('hidden');
            loadingSpinner.classList.add('hidden');
        }

        // Make the initial button click the hidden file input
        uploadButton.onclick = () => imageUpload.click();
    </script>
</body>
</html>
