<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Skin Type Analyzer</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .file-input-container {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }
        .file-input-button {
            cursor: pointer;
        }
        .file-input {
            position: absolute;
            font-size: 100px;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6; /* Tailwind blue-500 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 flex flex-col items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-lg bg-white rounded-2xl shadow-xl p-6 md:p-10">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">AI Skin Type Analyzer</h1>
            <p class="text-gray-600 mt-2">Upload a clear, front-facing photo to get started.</p>
        </header>

        <main>
            <div id="upload-section" class="text-center">
                <div id="image-preview-container" class="mb-6 hidden">
                    <p class="text-sm font-medium text-gray-600 mb-2">Your Photo:</p>
                    <img id="image-preview" src="#" alt="Your uploaded image" class="max-w-xs mx-auto rounded-lg shadow-md max-h-64"/>
                </div>
                <div class="file-input-container">
                    <button id="upload-button" class="file-input-button bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors duration-300 shadow-sm">
                        Select Your Photo
                    </button>
                    <input title="image-upload" type="file" id="image-upload" class="file-input" accept="image/jpeg, image/png, image/jpg">
                </div>
                <p id="file-name" class="mt-3 text-sm text-gray-500"></p>
            </div>

            <div id="loading-spinner" class="hidden flex justify-center items-center my-8">
               <div class="loader"></div>
            </div>

            <div id="results-section" class="hidden mt-8 text-center">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                    <h2 class="text-lg font-semibold text-gray-700 mb-1">Your Predicted Skin Type</h2>
                    <p id="prediction-label" class="text-3xl font-bold text-blue-800 capitalize"></p>
                    <p id="prediction-confidence" class="text-md text-gray-600 mt-1"></p>
                </div>
                <div class="mt-8 space-x-4">
                    <button onclick="resetApp()" class="bg-gray-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-700 transition-colors duration-300">Analyze Another</button>
                    <button id="recommend-button" class="bg-green-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-green-700 transition-colors duration-300">Recommend Products</button>
                </div>
            </div>

            <div id="error-message" class="hidden mt-6 text-center bg-red-100 border border-red-300 text-red-800 p-4 rounded-lg">
            </div>
        </main>
    </div>

    <div id="chatbot-section" class="w-full max-w-2xl bg-white rounded-2xl shadow-xl p-4 md:p-6 hidden">
        <div id="chat-messages" class="h-96 overflow-y-auto mb-4 p-4 bg-gray-50 rounded-lg border">
            </div>
        <form id="chat-form" class="flex items-center">
            <input type="text" id="chat-input" class="flex-grow border rounded-l-lg p-3 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ask a follow-up question..." autocomplete="off">
            <button type="submit" id="chat-send-button" class="bg-blue-600 text-white font-semibold p-3 rounded-r-lg hover:bg-blue-700 transition-colors">Send</button>
        </form>
         <div class="text-center">
            <button onclick="resetApp()" class="mt-4 text-sm text-gray-500 hover:text-gray-700">‚Üê Go Back to Analyzer</button>
        </div>
    </div>


    <footer class="text-center mt-6 text-sm text-gray-500">
        <p>&copy; 2025 SkinSight AI. For educational purposes only.</p>
    </footer>

    <script>
        // Get references to all the important DOM elements
        const imageUpload = document.getElementById('image-upload');
        const uploadButton = document.getElementById('upload-button');
        const fileNameDisplay = document.getElementById('file-name');
        
        const imagePreview = document.getElementById('image-preview');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        
        const uploadSection = document.getElementById('upload-section');
        const loadingSpinner = document.getElementById('loading-spinner');
        const resultsSection = document.getElementById('results-section');
        const errorMessageEl = document.getElementById('error-message');

        const predictionLabelEl = document.getElementById('prediction-label');
        const predictionConfidenceEl = document.getElementById('prediction-confidence');

        // NEW: References for the chatbot UI
        const mainContainer = document.querySelector('.w-full.max-w-lg');
        const chatbotSection = document.getElementById('chatbot-section');
        const chatMessages = document.getElementById('chat-messages');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const recommendButton = document.getElementById('recommend-button');

        // NEW: Global variable to store the skin type
        let currentSkinType = '';

        // Event Listeners
        imageUpload.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    imagePreview.src = e.target.result;
                    imagePreviewContainer.classList.remove('hidden');
                }
                reader.readAsDataURL(file);
                fileNameDisplay.textContent = `Selected: ${file.name}`;
                predict(file); 
            }
        });

        chatForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const userMessage = chatInput.value.trim();
            if (userMessage) {
                sendMessageToBot(userMessage);
                chatInput.value = '';
            }
        });
        
        recommendButton.addEventListener('click', showChatbot);
        
        uploadButton.onclick = () => imageUpload.click();


        // Main Prediction Function (from your original code)
        async function predict(file) {
            showLoading(true);

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/predict', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();

                if (response.ok && data.status === 'success') {
                    displayResults(data);
                } else {
                    displayError(data.error || 'An unknown error occurred.');
                }
            } catch (error) {
                console.error('Fetch Error:', error);
                displayError('Failed to connect to the server. Please try again.');
            } finally {
                showLoading(false);
            }
        }
        
        // UI State Management Functions
        function showLoading(isLoading) {
            if (isLoading) {
                uploadSection.classList.add('hidden');
                resultsSection.classList.add('hidden');
                errorMessageEl.classList.add('hidden');
                loadingSpinner.classList.remove('hidden');
            } else {
                loadingSpinner.classList.add('hidden');
            }
        }

        function displayResults(data) {
            uploadSection.classList.add('hidden');
            resultsSection.classList.remove('hidden');
            errorMessageEl.classList.add('hidden');
            
            // NEW: Store the prediction globally
            currentSkinType = data.prediction;

            predictionLabelEl.textContent = data.prediction;
            predictionConfidenceEl.textContent = `Confidence: ${(data.confidence * 100).toFixed(1)}%`;
        }

        function displayError(message) {
            uploadSection.classList.add('hidden');
            resultsSection.classList.add('hidden');
            errorMessageEl.textContent = `Error: ${message}`;
            errorMessageEl.classList.remove('hidden');
            errorMessageEl.innerHTML += `<br><button onclick="resetApp()" class="mt-4 bg-gray-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-700 transition-colors duration-300">Try Again</button>`;
        }

        function resetApp() {
            imageUpload.value = '';
            imagePreview.src = '#';
            imagePreviewContainer.classList.add('hidden');
            fileNameDisplay.textContent = '';
            
            mainContainer.classList.remove('hidden'); // Show the main analyzer
            chatbotSection.classList.add('hidden'); // Hide the chatbot

            uploadSection.classList.remove('hidden');
            resultsSection.classList.add('hidden');
            errorMessageEl.classList.add('hidden');
            loadingSpinner.classList.add('hidden');
            chatMessages.innerHTML = ''; // Clear chat history
        }

        // --- NEW: Chatbot Functions ---

        // Switches the view to the chatbot and sends the first message
        function showChatbot() {
            mainContainer.classList.add('hidden');
            chatbotSection.classList.remove('hidden');
            
            const initialQuestion = `what are the skin care product for ${currentSkinType} skin?`;
            sendMessageToBot(initialQuestion);
        }

        // Handles sending any message to your RAG API
        async function sendMessageToBot(messageText) {
            appendMessage('You', messageText);
            const typingIndicator = appendMessage('Bot', '...', true);

            try {
                const response = await fetch('https://ritesh-skin-care-chat-bot.onrender.com/query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        question: messageText
                    })
                });

                typingIndicator.remove();

                if (!response.ok) {
                    throw new Error('Network response was not ok.');
                }
                
                const data = await response.json();
                appendMessage('Bot', data.answer);

            } catch (error) {
                console.error("Chatbot API Error:", error);
                if (typingIndicator) typingIndicator.remove();
                appendMessage('Bot', "Sorry, I'm having trouble connecting. Please try again later.");
            }
        }

        // Helper function to add messages to the chat UI
        function appendMessage(sender, text, isTyping = false) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('mb-4');
            
            const senderClass = sender === 'You' ? 'text-right' : 'text-left';
            const bubbleClass = sender === 'You' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-800';
            
            // Use textContent for user messages and simple bot text to prevent XSS
            const contentDiv = document.createElement('div');
            // Only use innerHTML for bot responses that are expected to contain HTML
            if (sender === 'Bot' && !isTyping) {
                 contentDiv.innerHTML = text;
            } else {
                 contentDiv.textContent = text;
            }
            contentDiv.className = `inline-block rounded-lg px-4 py-2 ${bubbleClass}`;
            
            const outerDiv = document.createElement('div');
            outerDiv.className = senderClass;
            outerDiv.appendChild(contentDiv);
            
            messageDiv.appendChild(outerDiv);

            if (isTyping) {
                messageDiv.id = 'typing-indicator';
            }

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight; // Auto-scroll to bottom
            return messageDiv;
        }
    </script>
</body>
</html>